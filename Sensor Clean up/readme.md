# üßº MDI Cleanup Script (English version)

This script fully removes all traces of **Azure Advanced Threat Protection Sensor (MDI Sensor)** from a Windows system, including:

* Backing up relevant registry keys (not necessary)
* Stopping and deleting services
* Cleaning up GUID-based folders
* Deleting the install directory
* Logging all actions to a `.txt` file

---

## üì¶ Backup Registry Keys (not necessary)

```powershell
$backupPath = "C:\Temp\MdiSensorBackup"
if (!(Test-Path $backupPath)) {
    New-Item -ItemType Directory -Path $backupPath | Out-Null
}

$registryPaths = @(
    "HKLM:\SOFTWARE\Classes\Installer\Products\",
    "HKLM:\SOFTWARE\Classes\Installer\Features\",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
    "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
)

foreach ($guid in $guids) {
    foreach ($regPath in $registryPaths) {
        $fullKey = "$regPath$guid"

        if (Test-Path $fullKey) {
            $safeName = ($regPath -replace "[:\\]", "_") + $guid + ".reg"
            $backupFile = Join-Path $backupPath $safeName

            $exportCommand = "reg export `"$($fullKey -replace 'HKLM:', 'HKLM')`" `"$backupFile`" /y"
            cmd.exe /c $exportCommand

            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Backed up: $fullKey -> $backupFile"
            } else {
                Write-Warning "‚ö†Ô∏è Failed to back up: $fullKey"
            }
        } else {
            Write-Host "‚è≠Ô∏è Key not found: $fullKey"
        }
    }
}
```

---

## üßΩ Main Cleanup Script

```powershell
<#
.SYNOPSIS
    This PowerShell script fully removes all traces of the "Azure Advanced Threat Protection Sensor" from a Windows system.

.DESCRIPTION
    The script performs the following tasks:
    - Stops and deletes the related Windows services (`aatpsensor`, `aatpsensorupdater`)
    - Searches the registry for GUIDs associated with the sensor
    - Deletes registry entries and Package Cache folders matching those GUIDs
    - Deletes the sensor installation folder from "C:\Program Files"
    - Logs all actions and results for auditing

.PARAMETER searchTerm
    The display name of the target application in the registry (e.g., "Azure Advanced Threat Protection Sensor").

.PARAMETER logFile
    The path to a log file used to record all operations.

.NOTES
    Version   : 1.0
    Author    : MSlab
    Date      : 2024-10-28
    Requires  : Administrator privileges

.EXAMPLE
    1. Open PowerShell as Administrator.
    2. Navigate to the script's directory.
    3. Run the script using:
        .\Remove-MdiSensor.ps1

    You will be prompted for:
    - Confirmation to stop and delete related services
    - Confirmation to delete registry keys and cache folders
    - Confirmation to delete the installation folder

    A log file will be created at the script's location: MdiServiceDeletionLog.txt
#>

#---------------------- Function Definitions ----------------------#

function Write-Log {
    param (
        [string]$message,
        [string]$logFile
    )
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "$timestamp - $message"
    Add-Content -Path $logFile -Value $logEntry
}

function Delete-Service {
    param (
        [string]$serviceName,
        [string]$logFile
    )
    $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
    if ($service) {
        try {
            sc.exe stop $serviceName
            Write-Host "'$serviceName' service is being stopped..."
            Write-Log "'$serviceName' service is being stopped." -logFile $logFile

            $waitTime = 0
            while ((Get-Service -Name $serviceName -ErrorAction SilentlyContinue).Status -ne 'Stopped' -and $waitTime -lt 60) {
                Start-Sleep -Seconds 5
                $waitTime += 5
                Write-Host "Waiting for '$serviceName' to stop... $waitTime seconds elapsed."
                Write-Log "Waiting for '$serviceName' to stop... $waitTime seconds elapsed." -logFile $logFile
            }

            if ((Get-Service -Name $serviceName -ErrorAction SilentlyContinue).Status -eq 'Stopped') {
                Write-Host "'$serviceName' service has stopped."
                Write-Log "'$serviceName' service has stopped." -logFile $logFile
            } else {
                Write-Error "Failed to stop '$serviceName' within the timeout period."
                Write-Log "Failed to stop '$serviceName' within the timeout period." -logFile $logFile
                return
            }

            sc.exe delete $serviceName
            Write-Host "'$serviceName' service is being deleted..."
            Write-Log "'$serviceName' service is being deleted." -logFile $logFile

            Start-Sleep -Seconds 5
            $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
            if ($service -eq $null) {
                Write-Host "'$serviceName' service has been successfully deleted."
                Write-Log "'$serviceName' service has been successfully deleted." -logFile $logFile
            } else {
                Write-Error "Service '$serviceName' could not be deleted."
                Write-Log "Service '$serviceName' could not be deleted." -logFile $logFile
            }
        } catch {
            Write-Error "Failed to stop or delete service '$serviceName': $_"
            Write-Log "Failed to stop or delete service '$serviceName': $_" -logFile $logFile
        }
    } else {
        Write-Warning "Service '$serviceName' does not exist."
        Write-Log "Service '$serviceName' does not exist." -logFile $logFile
    }
}

function Delete-RegistryKeys {
    param (
        [string]$guid,
        [string]$logFile
    )
    $registryPaths = @(
        "HKLM:\SOFTWARE\Classes\Installer\Products\",
        "HKLM:\SOFTWARE\Classes\Installer\Features\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
    )
    foreach ($path in $registryPaths) {
        $regKey = "$path$guid"
        if (Test-Path $regKey) {
            Write-Host "Deleting registry key: $regKey"
            Remove-Item -Path $regKey -Recurse -Force
            Write-Log "Deleted registry key: $regKey" -logFile $logFile
        } else {
            Write-Warning "Registry key not found: $regKey"
            Write-Log "Registry key not found: $regKey" -logFile $logFile
        }
    }
}

function Delete-CacheFolder {
    param (
        [string]$guid,
        [string]$logFile
    )
    $packageCacheFolder = "C:\ProgramData\Package Cache\$guid"
    if (Test-Path $packageCacheFolder) {
        Remove-Item -Path $packageCacheFolder -Recurse -Force
        Write-Host "Deleted folder: $packageCacheFolder"
        Write-Log "Deleted folder: $packageCacheFolder" -logFile $logFile
    } else {
        Write-Warning "Cache folder not found: $packageCacheFolder"
        Write-Log "Cache folder not found: $packageCacheFolder" -logFile $logFile
    }
}

function Delete-InstallFolder {
    param (
        [string]$logFile
    )
    $installFolder = "C:\Program Files\Azure Advanced Threat Protection Sensor"
    if (Test-Path $installFolder) {
        Remove-Item -Path $installFolder -Recurse -Force
        Write-Host "Deleted installation folder: $installFolder"
        Write-Log "Deleted installation folder: $installFolder" -logFile $logFile
    } else {
        Write-Warning "Installation folder '$installFolder' does not exist."
        Write-Log "Installation folder '$installFolder' does not exist." -logFile $logFile
    }
}

function Find-GUIDs {
    param (
        [string]$searchTerm,
        [string]$logFile
    )
    $registryPaths = @(
        "HKLM:\SOFTWARE\Classes\Installer\Products\",
        "HKLM:\SOFTWARE\Classes\Installer\Features\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
    )
    $guids = @()
    foreach ($path in $registryPaths) {
        $subKeys = Get-ChildItem -Path $path -ErrorAction SilentlyContinue
        foreach ($key in $subKeys) {
            $keyPath = $path + $key.PSChildName
            $properties = Get-ItemProperty -Path $keyPath -ErrorAction SilentlyContinue
            if ($properties.DisplayName -eq $searchTerm -or $properties.ProductName -eq $searchTerm) {
                $guids += $key.PSChildName
                Write-Log "Found GUID $($key.PSChildName) for '$searchTerm'" -logFile $logFile
            }
        }
    }
    return $guids | Select-Object -Unique
}

#---------------------- Main Script Logic ----------------------#

$searchTerm = "Azure Advanced Threat Protection Sensor"
$logFile = Join-Path $PSScriptRoot "MdiServiceDeletionLog.txt"

Write-Log "Script started." -logFile $logFile

$confirmation = Read-Host "Do you want to stop and delete the services 'aatpsensor' and 'aatpsensorupdater'? (yes/no)"
if ($confirmation -eq 'yes') {
    Delete-Service -serviceName "aatpsensor" -logFile $logFile
    Delete-Service -serviceName "aatpsensorupdater" -logFile $logFile
} elseif ($confirmation -eq 'no') {
    Write-Host "Deletion process aborted by the user."
    Write-Log "Deletion process aborted by the user." -logFile $logFile
    exit
} else {
    Write-Host "Invalid input. Aborting the deletion process."
    Write-Log "Invalid input. Aborting the deletion process." -logFile $logFile
    exit
}

$guids = Find-GUIDs -searchTerm $searchTerm -logFile $logFile
if ($guids.Count -gt 0) {
    Write-Host "Found GUIDs for '$searchTerm':"
    $guids | ForEach-Object { Write-Host $_ }

    $confirmation = Read-Host "Do you want to delete registry keys and cache folders for these GUIDs? (yes/no)"
    if ($confirmation -eq 'yes') {
        foreach ($guid in $guids) {
            Delete-RegistryKeys -guid $guid -logFile $logFile
            Delete-CacheFolder -guid $guid -logFile $logFile
        }
    } elseif ($confirmation -eq 'no') {
        Write-Host "Registry and cache deletion skipped by the user."
        Write-Log "Registry and cache deletion skipped by the user." -logFile $logFile
    } else {
        Write-Host "Invalid input. Aborting."
        Write-Log "Invalid input. Aborting." -logFile $logFile
        exit
    }
} else {
    Write-Host "No GUIDs found for '$searchTerm'."
    Write-Log "No GUIDs found for '$searchTerm'." -logFile $logFile
}

$confirmation = Read-Host "Do you want to delete the installation folder for '$searchTerm'? (yes/no)"
if ($confirmation -eq 'yes') {
    Delete-InstallFolder -logFile $logFile
} elseif ($confirmation -eq 'no') {
    Write-Host "Installation folder deletion skipped by user."
    Write-Log "Installation folder deletion skipped by user." -logFile $logFile
} else {
    Write-Host "Invalid input. Aborting."
    Write-Log "Invalid input. Aborting." -logFile $logFile
    exit
}

Write-Log "Script completed." -logFile $logFile
```


‰ª•‰∏ãÊòØÂÆåÊï¥‰∏≠ÊñáÁâàÁöÑ **Azure Advanced Threat Protection SensorÔºàMDI SensorÔºâÊ∏ÖÁêÜËÑöÊú¨**ÔºåÂåÖÊã¨Ê≥®ÂÜåË°®Â§á‰ªΩ„ÄÅÊúçÂä°Âà†Èô§„ÄÅGUID Ê∏ÖÁêÜ„ÄÅÂÆâË£ÖÁõÆÂΩïÂà†Èô§‰ª•ÂèäÊìç‰ΩúÊó•ÂøóËÆ∞ÂΩï„ÄÇ

---

# üßº MDI Ê∏ÖÁêÜËÑöÊú¨Ôºà‰∏≠ÊñáÁâàÔºâ

ËØ•ËÑöÊú¨Â∞Ü‰ªé Windows Á≥ªÁªü‰∏≠**ÂΩªÂ∫ïÁßªÈô§ Azure È´òÁ∫ßÂ®ÅËÉÅÈò≤Êä§‰º†ÊÑüÂô®ÔºàMDI SensorÔºâ**ÔºåÂåÖÊã¨Ôºö

* Â§á‰ªΩÁõ∏ÂÖ≥Ê≥®ÂÜåË°®È°π (ÈùûÂøÖË¶Å)
* ÂÅúÊ≠¢Âπ∂Âà†Èô§Áõ∏ÂÖ≥ÊúçÂä°
* Ê∏ÖÈô§‰∏é GUID Áõ∏ÂÖ≥ÁöÑÁºìÂ≠òÊñá‰ª∂Â§π
* Âà†Èô§ÂÆâË£ÖÁõÆÂΩï
* ÊâÄÊúâÊìç‰ΩúÂÜôÂÖ• `.txt` Êó•ÂøóÊñá‰ª∂‰∏≠

---

## üì¶ Â§á‰ªΩÊ≥®ÂÜåË°®È°π (ÈùûÂøÖË¶Å)

```powershell
$backupPath = "C:\Temp\MdiSensorBackup"
if (!(Test-Path $backupPath)) {
    New-Item -ItemType Directory -Path $backupPath | Out-Null
}

$registryPaths = @(
    "HKLM:\SOFTWARE\Classes\Installer\Products\",
    "HKLM:\SOFTWARE\Classes\Installer\Features\",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
    "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
)

foreach ($guid in $guids) {
    foreach ($regPath in $registryPaths) {
        $fullKey = "$regPath$guid"

        if (Test-Path $fullKey) {
            $safeName = ($regPath -replace "[:\\]", "_") + $guid + ".reg"
            $backupFile = Join-Path $backupPath $safeName

            $exportCommand = "reg export `"$($fullKey -replace 'HKLM:', 'HKLM')`" `"$backupFile`" /y"
            cmd.exe /c $exportCommand

            if ($LASTEXITCODE -eq 0) {
                Write-Host "‚úÖ Â∑≤Â§á‰ªΩÔºö$fullKey -> $backupFile"
            } else {
                Write-Warning "‚ö†Ô∏è Êó†Ê≥ïÂ§á‰ªΩÔºö$fullKey"
            }
        } else {
            Write-Host "‚è≠Ô∏è Êú™ÊâæÂà∞È°πÔºö$fullKey"
        }
    }
}
```

---

## üßΩ ‰∏ªÊ∏ÖÁêÜËÑöÊú¨

```powershell
<#
.SYNOPSIS
    Êú¨ PowerShell ËÑöÊú¨ÂèØ‰ªéÁ≥ªÁªü‰∏≠ÂΩªÂ∫ïÁßªÈô§ ‚ÄúAzure È´òÁ∫ßÂ®ÅËÉÅÈò≤Êä§‰º†ÊÑüÂô®‚ÄùÔºàMDI SensorÔºâ„ÄÇ

.DESCRIPTION
    ÂäüËÉΩÂåÖÊã¨Ôºö
    - ÂÅúÊ≠¢Âπ∂Âà†Èô§Áõ∏ÂÖ≥ÊúçÂä°Ôºàaatpsensor, aatpsensorupdaterÔºâ
    - Êü•ÊâæÂπ∂Âà†Èô§Áõ∏ÂÖ≥Ê≥®ÂÜåË°®È°πÂíåÁºìÂ≠òÊñá‰ª∂Â§π
    - Âà†Èô§ÂÆâË£ÖÁõÆÂΩï
    - ÊâÄÊúâÊìç‰ΩúËÆ∞ÂΩïÂà∞Êó•ÂøóÊñá‰ª∂‰∏≠

.PARAMETER searchTerm
    Âú®Ê≥®ÂÜåË°®‰∏≠Áî®‰∫éÂåπÈÖçÁöÑÊòæÁ§∫ÂêçÁß∞ÔºàÂ¶Ç "Azure Advanced Threat Protection Sensor"Ôºâ„ÄÇ

.PARAMETER logFile
    Êìç‰ΩúÊó•ÂøóÁöÑËæìÂá∫Ë∑ØÂæÑ„ÄÇ

.NOTES
    ÁâàÊú¨     : 1.0  
    ‰ΩúËÄÖ     : MSlab  
    Êó•Êúü     : 2024-10-28  
    ÊùÉÈôêÈúÄÊ±Ç : ÁÆ°ÁêÜÂëòÊùÉÈôê

.EXAMPLE
    ‰ª•ÁÆ°ÁêÜÂëòÊùÉÈôêÊâìÂºÄ PowerShellÔºåËøõÂÖ•ËÑöÊú¨ÁõÆÂΩïÔºåËøêË°åÔºö
        .\Remove-MdiSensor.ps1

    ‰Ω†Â∞Ü‰ºöË¢´ÊèêÁ§∫ÊòØÂê¶Á°ÆËÆ§ÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºö
    - ÂÅúÊ≠¢Âπ∂Âà†Èô§Áõ∏ÂÖ≥ÊúçÂä°
    - Âà†Èô§Ê≥®ÂÜåË°®È°πÂíåÁºìÂ≠òÁõÆÂΩï
    - Âà†Èô§ÂÆâË£ÖÁõÆÂΩï

    Êó•ÂøóÂ∞Ü‰øùÂ≠òËá≥ËÑöÊú¨ÊâÄÂú®ÁõÆÂΩïÔºöMdiServiceDeletionLog.txt
#>

function Write-Log {
    param ([string]$message, [string]$logFile)
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Add-Content -Path $logFile -Value "$timestamp - $message"
}

function Delete-Service {
    param ([string]$serviceName, [string]$logFile)
    $service = Get-Service -Name $serviceName -ErrorAction SilentlyContinue
    if ($service) {
        try {
            sc.exe stop $serviceName
            Write-Host "Ê≠£Âú®ÂÅúÊ≠¢ÊúçÂä° '$serviceName'..."
            Write-Log "Ê≠£Âú®ÂÅúÊ≠¢ÊúçÂä° '$serviceName'" $logFile

            $waitTime = 0
            while ((Get-Service -Name $serviceName -ErrorAction SilentlyContinue).Status -ne 'Stopped' -and $waitTime -lt 60) {
                Start-Sleep -Seconds 5
                $waitTime += 5
                Write-Log "Á≠âÂæÖÊúçÂä°ÂÅúÊ≠¢Ôºö$waitTime Áßí" $logFile
            }

            if ((Get-Service -Name $serviceName -ErrorAction SilentlyContinue).Status -eq 'Stopped') {
                Write-Log "ÊúçÂä°Â∑≤ÂÅúÊ≠¢Ôºö$serviceName" $logFile
            } else {
                Write-Error "ÊúçÂä°Êú™ËÉΩÂú®Ë∂ÖÊó∂Êó∂Èó¥ÂÜÖÂÅúÊ≠¢Ôºö$serviceName"
                Write-Log "ÊúçÂä°Êú™ËÉΩÂÅúÊ≠¢Ôºö$serviceName" $logFile
                return
            }

            sc.exe delete $serviceName
            Start-Sleep -Seconds 5
            if (-not (Get-Service -Name $serviceName -ErrorAction SilentlyContinue)) {
                Write-Log "ÊúçÂä°Â∑≤ÊàêÂäüÂà†Èô§Ôºö$serviceName" $logFile
            } else {
                Write-Log "ÊúçÂä°Âà†Èô§Â§±Ë¥•Ôºö$serviceName" $logFile
            }
        } catch {
            Write-Error "Âà†Èô§ÊúçÂä°Â§±Ë¥•Ôºö$serviceName - $_"
            Write-Log "Âà†Èô§ÊúçÂä°Â§±Ë¥•Ôºö$serviceName - $_" $logFile
        }
    } else {
        Write-Log "ÊúçÂä°‰∏çÂ≠òÂú®Ôºö$serviceName" $logFile
    }
}

function Delete-RegistryKeys {
    param ([string]$guid, [string]$logFile)
    $registryPaths = @(
        "HKLM:\SOFTWARE\Classes\Installer\Products\",
        "HKLM:\SOFTWARE\Classes\Installer\Features\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
    )
    foreach ($path in $registryPaths) {
        $regKey = "$path$guid"
        if (Test-Path $regKey) {
            Remove-Item -Path $regKey -Recurse -Force
            Write-Log "Â∑≤Âà†Èô§Ê≥®ÂÜåË°®È°πÔºö$regKey" $logFile
        } else {
            Write-Log "Êú™ÊâæÂà∞Ê≥®ÂÜåË°®È°πÔºö$regKey" $logFile
        }
    }
}

function Delete-CacheFolder {
    param ([string]$guid, [string]$logFile)
    $folder = "C:\ProgramData\Package Cache\$guid"
    if (Test-Path $folder) {
        Remove-Item -Path $folder -Recurse -Force
        Write-Log "Â∑≤Âà†Èô§ÁºìÂ≠òÊñá‰ª∂Â§πÔºö$folder" $logFile
    } else {
        Write-Log "Êú™ÊâæÂà∞ÁºìÂ≠òÊñá‰ª∂Â§πÔºö$folder" $logFile
    }
}

function Delete-InstallFolder {
    param ([string]$logFile)
    $folder = "C:\Program Files\Azure Advanced Threat Protection Sensor"
    if (Test-Path $folder) {
        Remove-Item -Path $folder -Recurse -Force
        Write-Log "Â∑≤Âà†Èô§ÂÆâË£ÖÁõÆÂΩïÔºö$folder" $logFile
    } else {
        Write-Log "Êú™ÊâæÂà∞ÂÆâË£ÖÁõÆÂΩïÔºö$folder" $logFile
    }
}

function Find-GUIDs {
    param ([string]$searchTerm, [string]$logFile)
    $registryPaths = @(
        "HKLM:\SOFTWARE\Classes\Installer\Products\",
        "HKLM:\SOFTWARE\Classes\Installer\Features\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\",
        "HKLM:\SOFTWARE\Classes\Installer\Dependencies\"
    )
    $guids = @()
    foreach ($path in $registryPaths) {
        $subKeys = Get-ChildItem -Path $path -ErrorAction SilentlyContinue
        foreach ($key in $subKeys) {
            $keyPath = $path + $key.PSChildName
            $props = Get-ItemProperty -Path $keyPath -ErrorAction SilentlyContinue
            if ($props.DisplayName -eq $searchTerm -or $props.ProductName -eq $searchTerm) {
                $guids += $key.PSChildName
                Write-Log "ÂèëÁé∞ GUIDÔºö$($key.PSChildName)" $logFile
            }
        }
    }
    return $guids | Select-Object -Unique
}

# ---------------------- ‰∏ªÊµÅÁ®ã ---------------------- #

$searchTerm = "Azure Advanced Threat Protection Sensor"
$logFile = Join-Path $PSScriptRoot "MdiServiceDeletionLog.txt"

Write-Log "ËÑöÊú¨ÂºÄÂßãËøêË°å„ÄÇ" $logFile

$confirm = Read-Host "ÊòØÂê¶ÂÅúÊ≠¢Âπ∂Âà†Èô§ÊúçÂä° 'aatpsensor' Âíå 'aatpsensorupdater'? (yes/no)"
if ($confirm -eq 'yes') {
    Delete-Service "aatpsensor" $logFile
    Delete-Service "aatpsensorupdater" $logFile
} elseif ($confirm -eq 'no') {
    Write-Log "Áî®Êà∑ÂèñÊ∂à‰∫ÜÊúçÂä°Âà†Èô§Êìç‰Ωú„ÄÇ" $logFile
    exit
} else {
    Write-Log "Êó†ÊïàËæìÂÖ•ÔºåËÑöÊú¨‰∏≠Ê≠¢„ÄÇ" $logFile
    exit
}

$guids = Find-GUIDs $searchTerm $logFile
if ($guids.Count -gt 0) {
    Write-Host "ÊâæÂà∞‰ª•‰∏ã GUIDÔºö"
    $guids | ForEach-Object { Write-Host $_ }

    $confirm = Read-Host "ÊòØÂê¶Âà†Èô§Ëøô‰∫õ GUID ÁöÑÊ≥®ÂÜåË°®È°πÂíåÁºìÂ≠òÊñá‰ª∂Â§π? (yes/no)"
    if ($confirm -eq 'yes') {
        foreach ($guid in $guids) {
            Delete-RegistryKeys $guid $logFile
            Delete-CacheFolder $guid $logFile
        }
    } elseif ($confirm -eq 'no') {
        Write-Log "Áî®Êà∑Ë∑≥Ëøá‰∫Ü GUID Ê∏ÖÁêÜ„ÄÇ" $logFile
    } else {
        Write-Log "Êó†ÊïàËæìÂÖ•ÔºåËÑöÊú¨‰∏≠Ê≠¢„ÄÇ" $logFile
        exit
    }
} else {
    Write-Log "Êú™ÊâæÂà∞‰∏é '$searchTerm' Áõ∏ÂÖ≥ÁöÑ GUID„ÄÇ" $logFile
}

$confirm = Read-Host "ÊòØÂê¶Âà†Èô§ÂÆâË£ÖÁõÆÂΩïÔºü(yes/no)"
if ($confirm -eq 'yes') {
    Delete-InstallFolder $logFile
} elseif ($confirm -eq 'no') {
    Write-Log "Áî®Êà∑Ë∑≥Ëøá‰∫ÜÂÆâË£ÖÁõÆÂΩïÂà†Èô§„ÄÇ" $logFile
} else {
    Write-Log "Êó†ÊïàËæìÂÖ•ÔºåËÑöÊú¨‰∏≠Ê≠¢„ÄÇ" $logFile
    exit
}

Write-Log "ËÑöÊú¨ÊâßË°åÂÆåÊØï„ÄÇ" $logFile
```

